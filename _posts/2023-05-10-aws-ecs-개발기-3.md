---
layout: post
title: "AWS ECS ê°œë°œê¸° 3"
date: 2023-05-14
categories:
  - "ê°œë°œê¸°"
tags:
  - AWS
  - ECS
  - NestJS
image:
  path: /images/aws_ecs/Untitled 84.png
  thumbnail: /images/aws_ecs/Untitled 84.png
author: NOWIL
---

> ### Series
>
> 1. [aws-ecs-ê°œë°œê¸° - intro](/ê°œë°œê¸°/2023/05/14/aws-ecs-ê°œë°œê¸°-0.html)
> 2. [aws-ecs-ê°œë°œê¸° - 1](/ê°œë°œê¸°/2023/05/14/aws-ecs-ê°œë°œê¸°-1.html)
> 3. [aws-ecs-ê°œë°œê¸° - 2](/ê°œë°œê¸°/2023/05/14/aws-ecs-ê°œë°œê¸°-2.html)
> 4. [aws-ecs-ê°œë°œê¸° - 3](/ê°œë°œê¸°/2023/05/14/aws-ecs-ê°œë°œê¸°-3.html)

---

ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì¶œì²˜ : [5 Steps to Hosting Your Application on Amazon Cloud Container Service](https://jfrog.com/blog/5-steps-to-hosting-your-application-on-amazon-cloud-container-service/)

# 3ë¶€

ì´ì „ ì¥ì—ì„œ ECS ë°°í¬ë¥¼ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë²ˆ ì¥ì—” GitHubì˜ ì†ŒìŠ¤ ì½”ë“œ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ GitHub Actionsë¥¼ ì‚¬ìš©í•˜ì—¬ Amazon ECSì— ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•œ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

## WorkFlow

ì›Œí¬í”Œë¡œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![ì¶œì²˜ : [Github Actions + ECR + ECS](https://jeromedecoster.github.io/aws/github-actions-ecr-ecs/)](/images/aws_ecs/Untitled%2085.png)

ì¶œì²˜ : [Github Actions + ECR + ECS](https://jeromedecoster.github.io/aws/github-actions-ecr-ecs/)

![ì¶œì²˜ : [https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/bestpracticesguide/application.html](https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/bestpracticesguide/application.html)](/images/aws_ecs/Untitled%2086.png)

ì¶œì²˜ : [Best Practices - Running your application with Amazon ECS](https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/bestpracticesguide/application.html)

GitHubë¥¼ ì†ŒìŠ¤ ì½”ë“œ ë¦¬í¬ì§€í† ë¦¬ë¡œ ì‚¬ìš©í•˜ëŠ” ê²½ìš° GitHub ActionsëŠ” ëª¨ë“  GitHub ì´ë²¤íŠ¸ì—ì„œ ì›Œí¬í”Œë¡œë¥¼ ì‹œì‘í•˜ì—¬ ì§ì ‘ êµ¬í˜„í•  ê²½ìš° ë§¤ìš° ë³µì¡í•œ CI/CD ê¸°ëŠ¥ì„ ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

GitHub Actionsì€ íŠ¹ì • GitHub ì´ë²¤íŠ¸(ì˜ˆ: í’€, í‘¸ì‹œ ë˜ëŠ” ì»¤ë°‹)ì— ëŒ€í•œ ì‘ë‹µìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ëŠ” ì›Œí¬í”Œë¡œë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ë‹¤ë¥¸ GitHub ì‘ì—…ê³¼ ê²°í•©í•  ìˆ˜ ìˆëŠ” ê°œë³„ ê¸°ëŠ¥ ë‹¨ìœ„ì…ë‹ˆë‹¤. ì›Œí¬í”Œë¡œëŠ” GitHub í˜¸ìŠ¤íŒ… ì„œë²„ì˜ ê´€ë¦¬ í™˜ê²½ ë‚´ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

## Github Actions Secrets ì„¤ì •

![Untitled](/images/aws_ecs/Untitled%2087.png)

![Untitled](/images/aws_ecs/Untitled%2088.png)

## task-difinition json íŒŒì¼ ìƒì„±

í”„ë¡œì íŠ¸ ë£¨íŠ¸ ìœ„ì¹˜ì— task-difinition json íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤. íŒŒì¼ì˜ ë‚´ìš©ì€ ECSì˜ ì‘ì—… ì •ì˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸° í•˜ë©´ ë©ë‹ˆë‹¤.

![Untitled](/images/aws_ecs/Untitled%2089.png)

## **GitHub Actions yaml**

Amazon ECSì—ì„œ ì‹¤í–‰ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ CI/CD ì‘ì—…ì„ ì§€ì›í•˜ê¸° ìœ„í•´ AWSëŠ” [https://github.com/aws-actions](https://github.com/aws-actions) ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ JavaScript ê¸°ë°˜ GitHub Actionsì„ ì˜¤í”ˆ ì†ŒìŠ¤ë¡œ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.

- [github.com/aws-actions/configure-aws-credentials](http://github.com/aws-actions/configure-aws-credentials)Â â€“ GitHub Actionsì—ì„œ ì‚¬ìš©í•  AWS ìê²© ì¦ëª… ë° ì§€ì—­ í™˜ê²½ ë³€ìˆ˜ êµ¬ì„±
- [github.com/aws-actions/amazon-ecr-login](http://github.com/aws-actions/amazon-ecr-login)Â â€“ ë¡œì»¬ Docker í´ë¼ì´ì–¸íŠ¸ë¥¼ í•˜ë‚˜ ì´ìƒì˜ Amazon Elastic Container Registry(ECR) ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë¡œê·¸ì¸
- [github.com/aws-actions/amazon-AmazonÂ ECS-render-task-definition](http://github.com/aws-actions/amazon-ecs-render-task-definition)Â â€“ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ URIë¥¼ Amazon ECS ì‘ì—… ì •ì˜ JSON íŒŒì¼ì— ì‚½ì…
- [github.com/aws-actions/amazon-AmazonÂ ECS-deploy-task-definition](http://github.com/aws-actions/amazon-ecs-deploy-task-definition)Â â€“ Amazon ECS ì‘ì—… ì •ì˜ë¥¼ ë“±ë¡í•˜ê³  Amazon ECS ì„œë¹„ìŠ¤ì— ë°°í¬

ì°¸ê³  : [aws-actions/amazon-ecs-deploy-task-definition](https://github.com/aws-actions/amazon-ecs-deploy-task-definition)

```bash
/ecs-example/.github $tree -a -L 2
.
â””â”€â”€ workflows
    â””â”€â”€ aws.yaml

2 directories, 1 file
```

```yaml
name: Deploy to Amazon ECS

on:
  # Trigger the workflow on push or pull request,
  # but only for the main branch
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: sample-app
          IMAGE_TAG: latest
        run: |
          echo ${{ steps.login-ecr.outputs.registry }}
          # Build a docker container and
          # push it to ECR so that it can
          # be deployed to ECS.
          docker-compose build
          docker-compose push
          echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Render Amazon ECS task definition for mauve app container
        id: render-example-app-container
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: example-app-container
          image: {aws_account_id}.dkr.ecr.ap-northeast-2.amazonaws.com/ecs-sample-app:latest

      - name: Modify Amazon ECS task definition with reverse proxy container
        id: render-reverse-proxy-container
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.render-example-app-container.outputs.task-definition }}
          container-name: reverse-proxy-container
          image: {aws_account_id}.dkr.ecr.ap-northeast-2.amazonaws.com/reverse-proxy:latest

      - name: Deploy Amazon ECS task definition
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.render-reverse-proxy-container.outputs.task-definition }}
          service: sample-app-service
          cluster: sample-app-cluster
          wait-for-service-stability: true
```

ìœ„ ì½”ë“œë¥¼ ì‹œê°í™”í•˜ë©´ ì•„ë˜ ì´ë¯¸ì§€ì™€ ê°™ìŠµë‹ˆë‹¤.

![ì¶œì²˜ : [https://aws.amazon.com/ko/blogs/containers/create-a-ci-cd-pipeline-for-amazon-ecs-with-github-actions-and-aws-codebuild-tests/](https://aws.amazon.com/ko/blogs/containers/create-a-ci-cd-pipeline-for-amazon-ecs-with-github-actions-and-aws-codebuild-tests/)](/images/aws_ecs/Untitled%2090.png)

ì¶œì²˜ : [Create a CI/CD pipeline for Amazon ECS with GitHub Actions and AWS CodeBuild Tests](https://aws.amazon.com/ko/blogs/containers/create-a-ci-cd-pipeline-for-amazon-ecs-with-github-actions-and-aws-codebuild-tests/)

ì´ë²ˆ ì˜ˆì œì—ì„œëŠ” docker-composeë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆë“¤ì„ ë¹Œë“œí•©ë‹ˆë‹¤. ë”°ë¼ì„œ github actionsì˜ build-image ë‹¨ê³„ì—ì„œ `docker compose build`ì™€ `docker compose push` ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```yaml
- name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: sample-app
          IMAGE_TAG: latest
        run: |
					# docker compsoseì— ì •ì˜ëœ ê°ê°ì˜ ì„œë¹„ìŠ¤ë“¤ì˜ imageë“¤ì— ì„ ì–¸ëœ ECR URIë¡œ ë°°í¬ë©ë‹ˆë‹¤.
          docker-compose build
          docker-compose push
          echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
```

ê·¸ë¦¬ê³  ë‹¤ìŒ ë‹¨ê³„ì—ì„  ë¹Œë“œëœ ECR ì´ë¯¸ì§€ë“¤ì„ í†µí•´ task-definition.json íŒŒì¼ì˜ image tagë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

ì´ë¯¸ì§€ ê°œìˆ˜ë§Œí¼ `aws-actions/amazon-ecs-render-task-definition@v1` ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì²«ë²ˆ ì§¸ ì‘ì—…ì—ì„œ ë¦¬í¬ì§€í† ë¦¬ì˜ task-definition.jsonì„ ì„ ì–¸í•˜ê³  ë‹¤ìŒ ë‹¨ê³„ë¶€í„°ëŠ” ì´ì „ ë‹¨ê³„ì˜ outputsë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```yaml
...
uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
					# ì´ì „ ë‹¨ê³„ì¸ render-emerdy-app-containerì˜ outputsì˜ task-definition íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          task-definition: ${{ steps.render-example-app-container.outputs.task-definition }}
...
```

`ender-task-definition` ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ë‚˜ë©´ ë§ˆì§€ë§‰ ë‹¨ê³„ë¡œ `deploy-task-definition` ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

## git push ì‹¤í–‰ í›„ ìˆ˜ì • í™•ì¸

ì½”ë“œ commit ë‚´ìš©ì€ ê°„ë‹¨í•˜ê²Œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

![Untitled](/images/aws_ecs/Untitled%2091.png)

ì´ì œ github repositoryë¡œ pushë¥¼ í•´ë³´ê² ìŠµë‹ˆë‹¤.

![Untitled](/images/aws_ecs/Untitled%2092.png)

pushê°€ ì™„ë£Œë˜ê³  ë‚˜ë©´ actionsê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Untitled](/images/aws_ecs/Untitled%2093.png)

github actionsì˜ í˜¸ìŠ¤íŠ¸ì—ì„œ docker composeì— ì •ì˜ëœ ëŒ€ë¡œ ë¹Œë“œë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Untitled](/images/aws_ecs/Untitled%2094.png)

ê·¸ë¦¬ê³  ë¹Œë“œê°€ ì™„ë£Œë˜ë©´ taskê°€ ì—…ë°ì´íŠ¸ë˜ë©° ì„ ì–¸í•œ ecs í´ëŸ¬ìŠ¤í„°ì™€ ì„œë¹„ìŠ¤ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.

![Untitled](/images/aws_ecs/Untitled%2095.png)

github actions ì½˜ì†”ì˜ ë§í¬ë¡œ ì ‘ì†í•˜ì—¬ ê¸°ë‹¤ë¦¬ë©´ serviceÂ deployment completed ë˜ê³  service has reached a steady state. ë©”ì‹œì§€ë¡œ ë°°í¬ê°€ ì™„ë£Œë©ë‹ˆë‹¤.

![Untitled](/images/aws_ecs/Untitled%2096.png)

ê·¸ë¦¬ê³  github actionë„ successë˜ë©° ì™„ë£Œë©ë‹ˆë‹¤.

![Untitled](/images/aws_ecs/Untitled%2097.png)

ì´ì „ì— ì„¤ì •í•œ ë¡œë“œë°¸ëŸ°ì„œ DNSë¡œ ì ‘ì†í•˜ë©´ ì •ìƒì ìœ¼ë¡œ commití•œ ë‚´ìš©ì´ ë°˜ì˜ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

# Epilogue

## ë” ê°„í¸í•˜ê²Œ

ìš°ë¦¬ëŠ” 3ì¥ì— ê±¸ì³ AWS ECSë¥¼ í†µí•´ ê°„ë‹¨í•œ NestJS ì»¨í…Œì´ë„ˆ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì€ ë” ì‰½ê²Œ ì»¨í…Œì´ë„ˆ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬, ê´€ë¦¬, ìŠ¤ì¼€ì¼ë§í•´ì¤ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ëŸ¬í•œ ê³¼ì •ì„ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ë§ˆë‹¤ í•´ì•¼ í•˜ëŠ” ê±´ ê·¸ê²ƒ ë‚˜ë¦„ëŒ€ë¡œ ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë‚˜ì˜¨ ê°œë…ì´ ì½”ë“œë¡œì„œì˜ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ (Infrastructure as Code, IaC)ì…ë‹ˆë‹¤. IaCëŠ” ì½”ë“œë¡œ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ë¥¼ ê´€ë¦¬í•œë‹¤ëŠ” ê°œë…ìœ¼ë¡œ ì„œë¹„ìŠ¤ë§ˆë‹¤ ì„¤ì •í•œ ì–¸ì–´ì—ì„œëŠ” í•˜ì‹œì½”í”„ ì„¤ì • ì–¸ì–´ë¥¼ ì‚¬ìš©í•´ í´ë¼ìš°ë“œ ë¦¬ì†ŒìŠ¤ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤. IaCì˜ ëŒ€í‘œì ì¸ íˆ´ë¡œ Terraform, pulumi ë“±ì´ ìˆìŠµë‹ˆë‹¤.
![Terraform ë¡œê³  ì´ë¯¸ì§€](https://d2uleea4buiacg.cloudfront.net/files/8c7/8c7e6ba6534dedf5c5396faf3bc91989e71427d4d156783d54b4d7e4bce84c32.m.png)

ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” IaCë¥¼ í†µí•œ í´ë¼ìš°ë“œ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ë¥¼ ê´€ë¦¬í•˜ëŠ” ë‚´ìš©ì€ ë‹¤ë£¨ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì¶”í›„ í¬ìŠ¤íŠ¸ì—ì„œ ì§€ê¸ˆê¹Œì§€ êµ¬ì„±í•œ NestJS ì»¨í…Œì´ë„ˆ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ IaCë¥¼ í†µí•´ ê´€ë¦¬í•˜ëŠ” ë‚´ìš©ì„ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤. IaCì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ë“¤ì€ ì•„ë˜ ë§í¬ë“¤ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”! ğŸ™‡ğŸ»

- [Terraformìœ¼ë¡œ AWS ECS Fargate + Route53 ì›¹ ì„œë¹„ìŠ¤ ë°°í¬í•˜ê¸°](https://keyhyuk-kim.medium.com/terraform%EC%9C%BC%EB%A1%9C-aws-ecs-fargate-route53-%EC%9B%B9-%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B5%AC%EC%B6%95%ED%95%98%EA%B8%B0-1f85c30e77bc)
- [pulumi Documentation - AWS Elastic Container Service (ECS)](https://www.pulumi.com/docs/guides/crosswalk/aws/ecs/)
