name: Devlog Automation

on:
  # ìƒˆ ëŒ€í™” ë°±ì—… ê°ì§€ ì‹œ íŠ¸ë¦¬ê±°
  push:
    paths:
      - '_data/claude-conversations/**'
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ì‘ì—…'
        required: true
        default: 'notify'
        type: choice
        options:
          - notify
          - create-draft
          - summarize

  # ë§¤ì¼ ì•„ì¹¨ 9ì‹œì— ì‹¤í–‰ (KST)
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = KST 09:00

jobs:
  # ìƒˆ ëŒ€í™” ê°ì§€ ë° ì•Œë¦¼
  detect-and-notify:
    runs-on: ubuntu-latest
    outputs:
      has_new_conversations: ${{ steps.check.outputs.has_new }}
      conversation_count: ${{ steps.check.outputs.count }}
      topics: ${{ steps.check.outputs.topics }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for new conversations
        id: check
        run: |
          # ìµœê·¼ ë³€ê²½ëœ ëŒ€í™” íŒŒì¼ í™•ì¸
          CONV_DIR="_data/claude-conversations"
          
          if [ -d "$CONV_DIR" ]; then
            # ì˜¤ëŠ˜ ë‚ ì§œì˜ íŒŒì¼ í™•ì¸
            TODAY=$(date +%Y-%m-%d)
            NEW_FILES=$(find "$CONV_DIR" -name "*${TODAY}*" -type f 2>/dev/null | wc -l)
            
            if [ "$NEW_FILES" -gt 0 ]; then
              echo "has_new=true" >> $GITHUB_OUTPUT
              echo "count=$NEW_FILES" >> $GITHUB_OUTPUT
              
              # ì£¼ì œ ì¶”ì¶œ (JSON íŒŒì¼ì—ì„œ)
              TOPICS=$(cat "$CONV_DIR"/*.json 2>/dev/null | jq -r '.topic // .query // "Unknown"' 2>/dev/null | head -5 | tr '\n' ', ' || echo "N/A")
              echo "topics=$TOPICS" >> $GITHUB_OUTPUT
            else
              echo "has_new=false" >> $GITHUB_OUTPUT
              echo "count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_new=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: Create summary issue
        if: steps.check.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const count = '${{ steps.check.outputs.count }}';
            const topics = '${{ steps.check.outputs.topics }}';
            
            // ê¸°ì¡´ ì´ìŠˆ í™•ì¸
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'devlog-draft',
              state: 'open'
            });
            
            const existingIssue = issues.data.find(i => i.title.includes(today));
            
            const body = `## ğŸ“ ìƒˆë¡œìš´ Claude Code ëŒ€í™” ê°ì§€
            
**ë‚ ì§œ**: ${today}
**ëŒ€í™” ìˆ˜**: ${count}ê°œ
**ì£¼ìš” ì£¼ì œ**: ${topics}

---

### ğŸ“Œ ë‹¤ìŒ ë‹¨ê³„

Claude ì•±ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìš”ì²­í•˜ì„¸ìš”:

\`\`\`
ì˜¤ëŠ˜ codeì™€ ëŒ€í™”í•œ ë‚´ìš©ìœ¼ë¡œ ë¸”ë¡œê·¸ ì¨ì¤˜
\`\`\`

ë˜ëŠ” íŠ¹ì • ì£¼ì œë¡œ:

\`\`\`
ì˜¤ëŠ˜ [ì£¼ì œ] ê´€ë ¨ ëŒ€í™”ë¡œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë¸”ë¡œê·¸ ì‘ì„±í•´ì¤˜
\`\`\`

---

### ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì œëª© ì„ íƒ/ì…ë ¥
- [ ] ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì¶”ê°€
- [ ] ë‹¤ì´ì–´ê·¸ë¨ SVG ìƒì„±
- [ ] í¬ìŠ¤íŠ¸ ë‚´ìš© ê²€í† 
- [ ] GitHub í‘¸ì‹œ

---

*ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
            
            if (existingIssue) {
              // ê¸°ì¡´ ì´ìŠˆ ì—…ë°ì´íŠ¸
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              // ìƒˆ ì´ìŠˆ ìƒì„±
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ“ [Devlog] ${today} Claude Code ëŒ€í™” ì •ë¦¬`,
                body: body,
                labels: ['devlog-draft', 'automated']
              });
              console.log('Created new issue');
            }

  # ëŒ€í™” ìš”ì•½ ìƒì„±
  generate-summary:
    needs: detect-and-notify
    if: needs.detect-and-notify.outputs.has_new_conversations == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate conversation summary
        run: |
          # ëŒ€í™” ìš”ì•½ ìŠ¤í¬ë¦½íŠ¸
          CONV_DIR="_data/claude-conversations"
          SUMMARY_FILE="_data/daily-summary.md"
          TODAY=$(date +%Y-%m-%d)
          
          echo "# Claude Code ëŒ€í™” ìš”ì•½ - $TODAY" > "$SUMMARY_FILE"
          echo "" >> "$SUMMARY_FILE"
          echo "ìƒì„± ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')" >> "$SUMMARY_FILE"
          echo "" >> "$SUMMARY_FILE"
          
          # JSON íŒŒì¼ì—ì„œ ì£¼ì œ ì¶”ì¶œ
          for file in "$CONV_DIR"/*${TODAY}*.json; do
            if [ -f "$file" ]; then
              echo "## $(basename "$file")" >> "$SUMMARY_FILE"
              echo "" >> "$SUMMARY_FILE"
              head -100 "$file" >> "$SUMMARY_FILE" 2>/dev/null || true
              echo "" >> "$SUMMARY_FILE"
              echo "---" >> "$SUMMARY_FILE"
            fi
          done

      - name: Commit summary
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if [ -f "_data/daily-summary.md" ]; then
            git add _data/daily-summary.md
            git diff --cached --quiet || git commit -m "summary: $(date +%Y-%m-%d) ëŒ€í™” ìš”ì•½ ìƒì„±"
            git push || echo "Nothing to push"
          fi
