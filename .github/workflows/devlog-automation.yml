name: Devlog Automation

on:
  # 매일 자정 (KST 09:00 = UTC 00:00) 실행
  schedule:
    - cron: '0 15 * * *'  # UTC 15:00 = KST 00:00

  # 수동 실행
  workflow_dispatch:
    inputs:
      action:
        description: '실행할 작업'
        required: true
        default: 'backup'
        type: choice
        options:
          - backup
          - clean-old-theme

  # _posts 또는 assets/images 변경 시 실행
  push:
    branches:
      - main
      - master
    paths:
      - '_posts/**'
      - 'assets/images/posts/**'

jobs:
  # 대화 백업 작업
  backup:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'backup')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create backup directory
        run: mkdir -p _data/claude-conversations

      - name: Create daily backup file
        run: |
          TODAY=$(date +%Y-%m-%d)
          BACKUP_FILE="_data/claude-conversations/$TODAY.md"

          if [ ! -f "$BACKUP_FILE" ]; then
            cat > "$BACKUP_FILE" << EOF
          ---
          date: $TODAY
          generated_at: $(date +"%Y-%m-%d %H:%M:%S %z")
          auto_generated: true
          ---

          # Claude Code 대화 기록 - $TODAY

          > 이 파일은 자동으로 생성되었습니다.
          > 대화 내용을 추가하려면 로컬에서 편집하세요.

          ## 요약



          ## 대화 내용



          EOF
            echo "Created backup file: $BACKUP_FILE"
          else
            echo "Backup file already exists: $BACKUP_FILE"
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _data/claude-conversations/
          git diff --staged --quiet || git commit -m "Auto backup: $(date +%Y-%m-%d)"
          git push || echo "Nothing to push"

  # 이전 테마 파일 정리 (so-simple → chirpy 마이그레이션 후)
  clean-old-theme:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'clean-old-theme'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean old theme files
        run: |
          # 이전 테마(so-simple)의 잔여 파일 삭제
          rm -rf _sass _includes _layouts _data 2>/dev/null || true
          rm -rf assets/css assets/js 2>/dev/null || true
          echo "Old theme files cleaned"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Clean old theme files"
          git push || echo "Nothing to push"

  # 블로그 빌드 테스트
  build-test:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Build Jekyll
        run: |
          bundle install
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Check build output
        run: |
          if [ -d "_site" ]; then
            echo "✅ Build successful!"
            echo "Files generated: $(find _site -type f | wc -l)"
          else
            echo "❌ Build failed - _site directory not found"
            exit 1
          fi
